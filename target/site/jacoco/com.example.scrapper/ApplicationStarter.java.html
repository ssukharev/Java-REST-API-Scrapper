<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationStarter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">REST API Scrapper</a> &gt; <a href="index.source.html" class="el_package">com.example.scrapper</a> &gt; <span class="el_source">ApplicationStarter.java</span></div><h1>ApplicationStarter.java</h1><pre class="source lang-java linenums">package com.example.scrapper;
import com.example.scrapper.client.ApiClient;
import com.example.scrapper.parser.ApiParser;
import com.example.scrapper.util.ApiScrapperTask;
import com.example.scrapper.util.FileWriterUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

<span class="nc" id="L16">public class ApplicationStarter {</span>
<span class="fc" id="L17">    private static final Logger logger = LoggerFactory.getLogger(ApplicationStarter.class);</span>
    private static FileWriterUtil fileWriterUtil;

    public static void start(String[] args) {
<span class="nc bnc" id="L21" title="All 2 branches missed.">        if (args.length &lt; 4) {</span>
<span class="nc" id="L22">            logger.info(&quot;Usage: java -jar rest-api-scrapper.jar &lt;maxThreads&gt; &lt;timeoutSeconds&gt; &lt;servicesCommaSeparated&gt; &lt;fileFormat(CSV/JSON)&gt;&quot;);</span>
<span class="nc" id="L23">            System.exit(1);</span>
        }

<span class="nc" id="L26">        final ScheduledExecutorService scheduler = startTasks(args);</span>

        // Демон-поток для прослушивания ввода команды &quot;exit&quot;
<span class="nc" id="L29">        Thread exitListener = new Thread(() -&gt; {</span>
<span class="nc" id="L30">            Scanner scanner = new Scanner(System.in);</span>
            while (true) {
<span class="nc" id="L32">                String line = scanner.nextLine();</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">                if (&quot;exit&quot;.equalsIgnoreCase(line.trim())) {</span>
<span class="nc" id="L34">                    logger.info(&quot;Получена команда exit. Завершаем работу...&quot;);</span>
<span class="nc" id="L35">                    scheduler.shutdownNow();</span>
<span class="nc" id="L36">                    break;</span>
                }
<span class="nc" id="L38">            }</span>
<span class="nc" id="L39">            scanner.close();</span>
<span class="nc" id="L40">        });</span>
<span class="nc" id="L41">        exitListener.setDaemon(true);</span>
<span class="nc" id="L42">        exitListener.start();</span>

        try {
<span class="nc" id="L45">            boolean terminated = scheduler.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">            if (!terminated) {</span>
<span class="nc" id="L47">                logger.info(&quot;Scheduler не завершился вовремя. Принудительное завершение.&quot;);</span>
<span class="nc" id="L48">                scheduler.shutdownNow();</span>
            }
<span class="nc" id="L50">        } catch (InterruptedException e) {</span>
<span class="nc" id="L51">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L52">            logger.error(&quot;Main thread interrupted&quot;, e);</span>
<span class="nc" id="L53">        }</span>

        // Закрываем файл
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (fileWriterUtil != null) {</span>
<span class="nc" id="L57">            fileWriterUtil.closeFile();</span>
        }
<span class="nc" id="L59">    }</span>

    private static ScheduledExecutorService startTasks(String[] args) {
        int maxThreads;
        int timeoutSeconds;
        try {
<span class="fc" id="L65">            maxThreads = Integer.parseInt(args[0]);</span>
<span class="fc" id="L66">            timeoutSeconds = Integer.parseInt(args[1]);</span>
<span class="nc" id="L67">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L68">            logger.error(&quot;Неверный формат числа для maxThreads или timeoutSeconds&quot;, e);</span>
<span class="nc" id="L69">            System.exit(1);</span>
<span class="nc" id="L70">            return null;</span>
<span class="fc" id="L71">        }</span>

<span class="fc" id="L73">        String[] services = args[2].split(&quot;,&quot;);</span>
<span class="fc" id="L74">        String fileFormat = args[3].toUpperCase();</span>

        // Создаём FileWriterUtil в режиме перезаписи (а не добавления)
<span class="fc" id="L77">        fileWriterUtil = new FileWriterUtil(&quot;src/main/resources/output.&quot; + fileFormat.toLowerCase(), fileFormat);</span>

<span class="fc" id="L79">        List&lt;String&gt; invalidServices = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L80">        List&lt;String&gt; validServices = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L81">        int validTaskCount = 0;</span>
<span class="fc" id="L82">        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(maxThreads);</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">        for (String service : services) {</span>
<span class="fc" id="L85">            service = service.trim();</span>
            ApiScrapperTask task;
<span class="fc bfc" id="L87" title="All 4 branches covered.">            switch (service.toLowerCase()) {</span>
                case &quot;newsapi&quot;:
<span class="fc" id="L89">                    task = new ApiScrapperTask(new ApiClient(), new ApiParser(), fileWriterUtil, &quot;newsapi&quot;);</span>
<span class="fc" id="L90">                    validServices.add(&quot;NewsApi&quot;);</span>
<span class="fc" id="L91">                    break;</span>
                case &quot;currentsapi&quot;:
<span class="fc" id="L93">                    task = new ApiScrapperTask(new ApiClient(), new ApiParser(), fileWriterUtil, &quot;currentsapi&quot;);</span>
<span class="fc" id="L94">                    validServices.add(&quot;CurrentsApi&quot;);</span>
<span class="fc" id="L95">                    break;</span>
                case &quot;openweathermap&quot;:
<span class="fc" id="L97">                    task = new ApiScrapperTask(new ApiClient(), new ApiParser(), fileWriterUtil, &quot;openweathermap&quot;);</span>
<span class="fc" id="L98">                    validServices.add(&quot;OpenWeatherMap&quot;);</span>
<span class="fc" id="L99">                    break;</span>
                default:
<span class="fc" id="L101">                    invalidServices.add(service);</span>
<span class="fc" id="L102">                    continue;</span>
            }
<span class="fc" id="L104">            scheduler.scheduleWithFixedDelay(task, 0, timeoutSeconds, TimeUnit.SECONDS);</span>
<span class="fc" id="L105">            validTaskCount++;</span>
        }

<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (!invalidServices.isEmpty()) {</span>
<span class="fc" id="L109">            logger.info(&quot;Следующие сервисы не распознаны: {}&quot;, String.join(&quot;, &quot;, invalidServices));</span>
        }
<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (!validServices.isEmpty()) {</span>
<span class="fc" id="L112">            logger.info(&quot;Обрабатываются следующие сервисы: {}&quot;, String.join(&quot;, &quot;, validServices));</span>
        }
<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (validTaskCount == 0) {</span>
<span class="fc" id="L115">            logger.info(&quot;Нет корректных сервисов для опроса. Завершаем работу.&quot;);</span>
            // Если тестовый режим, бросаем исключение, иначе вызываем System.exit(1)
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">            if (Boolean.getBoolean(&quot;test.mode&quot;)) {</span>
<span class="fc" id="L118">                throw new IllegalStateException(&quot;No valid services&quot;);</span>
            } else {
<span class="nc" id="L120">                System.exit(1);</span>
            }
        }


<span class="fc" id="L125">        return scheduler;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>